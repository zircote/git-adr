# GitLab CI pipeline for git-adr sync
# Generated by: git adr ci gitlab --sync
#
# This pipeline syncs ADR notes to the repository wiki on push to main.
# Notes are fetched and can optionally be exported or synced to wiki.

stages:
  - fetch
  - validate
  - sync
  - export

variables:
  GIT_DEPTH: 0  # Full clone for notes
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"

cache:
  paths:
    - .cache/pip/

# Fetch ADR notes from remote
fetch-notes:
  stage: fetch
  image: python:{{ python_version | default('3.11') }}-slim
  before_script:
    - apt-get update && apt-get install -y git
    - pip install git-adr{% if git_adr_version %}=={{ git_adr_version }}{% endif %}
  script:
    - git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
    - git fetch origin 'refs/notes/*:refs/notes/*'
    # Initialize local git-adr config (required for commands to work)
    - git adr init --no-input --force
    - git adr list --format table
  rules:
    - if: $CI_COMMIT_BRANCH == "{{ main_branch | default('main') }}"
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_PIPELINE_SOURCE == "web"  # Manual trigger

{% if validate_adrs %}
# Validate ADR structure and format
validate-adrs:
  stage: validate
  image: python:{{ python_version | default('3.11') }}-slim
  needs:
    - fetch-notes
  before_script:
    - apt-get update && apt-get install -y git jq
    - pip install git-adr{% if git_adr_version %}=={{ git_adr_version }}{% endif %}
  script:
    # Fetch notes (each job runs in isolated container)
    - git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
    - git fetch origin 'refs/notes/*:refs/notes/*'
    # Initialize local git-adr config (required for commands to work)
    - git adr init --no-input --force
    - |
      ERRORS=""

      # Validate each ADR
      for adr in $(git adr list --format json | jq -r '.[].id'); do
        content=$(git adr show "$adr" --format markdown 2>/dev/null || echo "")

        if [ -z "$content" ]; then
          ERRORS="${ERRORS}ADR $adr: Cannot read content\n"
          continue
        fi

        # Check required sections
        echo "$content" | grep -qi "## Status" || ERRORS="${ERRORS}ADR $adr: Missing Status\n"
        echo "$content" | grep -qi "## Context" || ERRORS="${ERRORS}ADR $adr: Missing Context\n"
        echo "$content" | grep -qi "## Decision" || ERRORS="${ERRORS}ADR $adr: Missing Decision\n"
      done

      if [ -n "$ERRORS" ]; then
        echo -e "Validation Errors:\n$ERRORS"
        exit 1
      fi

      echo "All ADRs validated successfully"
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
{% if allow_failure_validate %}
  allow_failure: true
{% endif %}

{% endif %}
{% if wiki_sync %}
# Sync ADRs to wiki
sync-wiki:
  stage: sync
  image: python:{{ python_version | default('3.11') }}-slim
  needs:
    - fetch-notes
{% if validate_adrs %}
    - validate-adrs
{% endif %}
  before_script:
    - apt-get update && apt-get install -y git
    - pip install git-adr[wiki]{% if git_adr_version %}=={{ git_adr_version }}{% endif %}
  script:
    # Fetch notes (each job runs in isolated container)
    - git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
    - git fetch origin 'refs/notes/*:refs/notes/*'
    # Initialize local git-adr config (required for commands to work)
    - git adr init --no-input --force
{% if wiki_provider == 'gitlab' %}
    - git adr wiki init --provider gitlab || true
    - git adr wiki sync
{% elif wiki_provider == 'confluence' %}
    - |
      git adr wiki init --provider confluence \
        --url "$CONFLUENCE_URL" \
        --space "$CONFLUENCE_SPACE" || true
      git adr wiki sync
{% endif %}
  rules:
    - if: $CI_COMMIT_BRANCH == "{{ main_branch | default('main') }}"
  variables:
{% if wiki_provider == 'gitlab' %}
    GITLAB_TOKEN: $CI_JOB_TOKEN
{% elif wiki_provider == 'confluence' %}
    CONFLUENCE_URL: $CONFLUENCE_URL
    CONFLUENCE_SPACE: $CONFLUENCE_SPACE
    CONFLUENCE_TOKEN: $CONFLUENCE_TOKEN
{% endif %}

{% endif %}
{% if export_format %}
# Export ADRs to artifact
export-adrs:
  stage: export
  image: python:{{ python_version | default('3.11') }}-slim
  needs:
    - fetch-notes
  before_script:
    - apt-get update && apt-get install -y git
    - pip install git-adr{% if git_adr_version %}=={{ git_adr_version }}{% endif %}{% if export_format == 'docx' %}[export]{% endif %}
  script:
    # Fetch notes (each job runs in isolated container)
    - git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
    - git fetch origin 'refs/notes/*:refs/notes/*'
    # Initialize local git-adr config (required for commands to work)
    - git adr init --no-input --force
    - mkdir -p {{ export_dir | default('adr-export') }}
    - git adr export --format {{ export_format }} --output {{ export_dir | default('adr-export') }}/
  artifacts:
    paths:
      - {{ export_dir | default('adr-export') }}/
    expire_in: {{ artifact_retention | default('30 days') }}
  rules:
    - if: $CI_COMMIT_BRANCH == "{{ main_branch | default('main') }}"

{% endif %}
# Summary job
adr-summary:
  stage: .post
  image: python:{{ python_version | default('3.11') }}-slim
  needs:
    - fetch-notes
  before_script:
    - apt-get update && apt-get install -y git jq
    - pip install git-adr{% if git_adr_version %}=={{ git_adr_version }}{% endif %}
  script:
    # Fetch notes (each job runs in isolated container)
    - git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
    - git fetch origin 'refs/notes/*:refs/notes/*'
    # Initialize local git-adr config (required for commands to work)
    - git adr init --no-input --force
    - |
      echo "=== ADR Summary ==="
      echo "Total ADRs: $(git adr list --format json | jq '. | length')"
      echo "Proposed: $(git adr list --status proposed --format json | jq '. | length')"
      echo "Accepted: $(git adr list --status accepted --format json | jq '. | length')"
      echo "Deprecated: $(git adr list --status deprecated --format json | jq '. | length')"
      echo "==================="
  rules:
    - if: $CI_COMMIT_BRANCH == "{{ main_branch | default('main') }}"
