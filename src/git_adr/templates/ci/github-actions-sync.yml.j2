# GitHub Actions workflow for git-adr sync
# Generated by: git adr ci github --sync
#
# This workflow syncs ADR notes to the repository wiki on push to main.
# Notes are fetched from the remote and can optionally be exported to the wiki.

name: Sync ADRs

on:
  push:
    branches:
      - {{ main_branch | default('main') }}
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
{% if wiki_sync %}
  pages: write  # Required for wiki sync
{% endif %}

jobs:
  sync-adrs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for notes

      - name: Fetch git notes
        run: |
          # Configure notes refs for fetching
          git config --add remote.origin.fetch '+refs/notes/*:refs/notes/*'
          git fetch origin 'refs/notes/*:refs/notes/*'

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '{{ python_version | default("3.11") }}'

      - name: Install git-adr
        run: pip install git-adr{% if git_adr_version %}=={{ git_adr_version }}{% endif %}

      - name: Initialize git-adr
        run: |
          # Initialize local git-adr config even when notes already exist from fetch
          # Required because git-adr commands check adr.initialized config
          git adr init --no-input --force

{% if validate_adrs %}
      - name: Validate ADRs
        run: |
          # Check ADR structure and metadata
          git adr list --format json > /dev/null
          echo "ADR validation passed"

{% endif %}
{% if wiki_sync %}
      - name: Sync to wiki
        env:
          GITHUB_TOKEN: {% raw %}${{ secrets.GITHUB_TOKEN }}{% endraw %}
{% if wiki_provider == 'github' %}
        run: |
          # Initialize wiki if not already done
          git adr wiki init --provider github || true
          # Sync ADRs to wiki
          git adr wiki sync
{% elif wiki_provider == 'confluence' %}
        run: |
          # Sync to Confluence (requires CONFLUENCE_* env vars)
          git adr wiki init --provider confluence \
            --url "$CONFLUENCE_URL" \
            --space "$CONFLUENCE_SPACE" || true
          git adr wiki sync
        env:
          CONFLUENCE_URL: {% raw %}${{ secrets.CONFLUENCE_URL }}{% endraw %}
          CONFLUENCE_SPACE: {% raw %}${{ secrets.CONFLUENCE_SPACE }}{% endraw %}
          CONFLUENCE_TOKEN: {% raw %}${{ secrets.CONFLUENCE_TOKEN }}{% endraw %}
{% endif %}

{% endif %}
{% if export_format %}
      - name: Export ADRs
        run: |
          mkdir -p {{ export_dir | default('docs/adr') }}
          git adr export --format {{ export_format }} --output {{ export_dir | default('docs/adr') }}/

      - name: Upload ADR artifacts
        uses: actions/upload-artifact@v4
        with:
          name: adr-export
          path: {{ export_dir | default('docs/adr') }}/
          retention-days: {{ artifact_retention | default(30) }}

{% endif %}
      - name: Summary
        run: |
          echo "## ADR Sync Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Total ADRs | $(git adr list --format json 2>/dev/null | jq '. | length' || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Proposed | $(git adr list --status proposed --format json 2>/dev/null | jq '. | length' || echo 0) |" >> $GITHUB_STEP_SUMMARY
          echo "| Accepted | $(git adr list --status accepted --format json 2>/dev/null | jq '. | length' || echo 0) |" >> $GITHUB_STEP_SUMMARY
