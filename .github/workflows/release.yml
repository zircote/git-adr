name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  id-token: write

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Build package
        run: uv build

      - name: Upload package artifacts
        uses: actions/upload-artifact@v6
        with:
          name: dist
          path: dist/

  build-release-artifacts:
    name: Build Release Artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.12

      - name: Install pandoc
        run: sudo apt-get update && sudo apt-get install -y pandoc

      - name: Install package in development mode
        run: uv sync --all-extras

      - name: Build all artifacts (man pages + completions)
        run: make build

      - name: Create release tarball
        env:
          VERSION: ${{ github.ref_name }}
        run: |
          VERSION="${VERSION#v}"
          RELEASE_DIR="git-adr-${VERSION}"
          mkdir -p "${RELEASE_DIR}"

          # Structure matches git-lfs: binary instructions + man + completions + install
          cp -r share/man "${RELEASE_DIR}/" 2>/dev/null || true
          cp -r share/completions "${RELEASE_DIR}/" 2>/dev/null || true
          cp script/install.sh "${RELEASE_DIR}/"
          chmod +x "${RELEASE_DIR}/install.sh"
          cp README.md "${RELEASE_DIR}/"
          cp CHANGELOG.md "${RELEASE_DIR}/" 2>/dev/null || true
          cp LICENSE "${RELEASE_DIR}/" 2>/dev/null || true

          # Single tarball (Python package is platform-independent)
          tar -czvf "git-adr-${VERSION}.tar.gz" "${RELEASE_DIR}"

      - name: Upload release artifacts
        uses: actions/upload-artifact@v6
        with:
          name: release-artifacts
          path: |
            git-adr-*.tar.gz

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [build, build-release-artifacts]
    steps:
      - uses: actions/checkout@v6

      - name: Download package artifacts
        uses: actions/download-artifact@v6
        with:
          name: dist
          path: dist/

      - name: Download release artifacts
        uses: actions/download-artifact@v6
        with:
          name: release-artifacts
          path: release/

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            dist/*
            release/*
          generate_release_notes: true
          body: |
            ## Installation

            ### Homebrew (macOS)
            ```bash
            brew tap zircote/git-adr
            brew install git-adr
            ```

            ### Via pip/uv
            ```bash
            pip install git-adr
            # or
            uv tool install git-adr
            ```

            ### From release tarball (includes man pages + completions)
            ```bash
            # Download and extract (replace VERSION with actual version, e.g., 0.1.0)
            VERSION=${{ github.ref_name }}
            curl -sL https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/git-adr-${VERSION#v}.tar.gz | tar xz
            cd git-adr-*/

            # Install (installs package via pip/uv, man pages, and completions)
            ./install.sh --local  # or: sudo ./install.sh

            # Or install man pages only
            sudo ./install.sh --man-only
            ```

            ### Shell completion
            After installing, enable shell completion:
            ```bash
            git-adr completion bash --install
            git-adr completion zsh --install
            git-adr completion fish --install
            ```

            ### Usage
            ```bash
            git adr init              # Initialize in a repository
            git adr new "Title"       # Create an ADR
            git adr list              # List all ADRs
            man git-adr               # View documentation
            ```

  publish:
    name: Publish to PyPI
    runs-on: ubuntu-latest
    needs: build
    environment: pypi
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v6
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  update-homebrew:
    name: Update Homebrew Formula
    runs-on: ubuntu-latest
    needs: publish
    steps:
      - name: Wait for PyPI availability
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${REF_NAME#v}"
          echo "Waiting for git-adr==${VERSION} on PyPI..."
          for i in {1..30}; do
            if curl -sf "https://pypi.org/pypi/git-adr/${VERSION}/json" > /dev/null 2>&1; then
              echo "Package available on PyPI"
              break
            fi
            echo "Attempt $i: Not yet available, waiting 10s..."
            sleep 10
          done

      - name: Get PyPI SHA256
        id: pypi
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${REF_NAME#v}"
          PYPI_JSON=$(curl -sf "https://pypi.org/pypi/git-adr/${VERSION}/json")
          SDIST_URL=$(echo "$PYPI_JSON" | jq -r '.urls[] | select(.packagetype=="sdist") | .url')
          SDIST_SHA256=$(echo "$PYPI_JSON" | jq -r '.urls[] | select(.packagetype=="sdist") | .digests.sha256')
          echo "url=${SDIST_URL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SDIST_SHA256}" >> "$GITHUB_OUTPUT"
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Checkout Homebrew tap
        uses: actions/checkout@v4
        with:
          repository: zircote/homebrew-git-adr
          token: ${{ secrets.HOMEBREW_TAP_TOKEN }}
          path: homebrew-tap

      - name: Update formula
        env:
          VERSION: ${{ steps.pypi.outputs.version }}
          SHA256: ${{ steps.pypi.outputs.sha256 }}
          URL: ${{ steps.pypi.outputs.url }}
        run: |
          cd homebrew-tap
          sed -i 's|url ".*"|url "'"${URL}"'"|' Formula/git-adr.rb
          sed -i 's|sha256 ".*"|sha256 "'"${SHA256}"'"|' Formula/git-adr.rb
          sed -i '/# NOTE: Update to PyPI URL/d' Formula/git-adr.rb
          sed -i '/# url "https:\/\/files.pythonhosted.org/d' Formula/git-adr.rb

      - name: Commit and push
        env:
          VERSION: ${{ steps.pypi.outputs.version }}
        run: |
          cd homebrew-tap
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/git-adr.rb
          git commit -m "git-adr ${VERSION}"
          git push
