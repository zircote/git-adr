name: Deploy Documentation

on:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "Cargo.toml"
      - ".github/workflows/deploy-docs.yml"
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: "Documentation version label"
        required: false
        default: "latest"

permissions:
  contents: read
  actions: write

env:
  CARGO_TERM_COLOR: always

jobs:
  build-and-deploy:
    name: Build and Deploy Documentation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Fetch git notes
        run: |
          git fetch origin 'refs/notes/*:refs/notes/*' || echo "No notes refs found"

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Build Rust documentation
        run: |
          cargo doc --no-deps --all-features
          # Create redirect to main crate docs
          echo '<meta http-equiv="refresh" content="0; url=git_adr/index.html">' > target/doc/index.html

      - name: Build git-adr binary
        run: cargo build --release

      - name: Export ADRs from git notes
        run: |
          mkdir -p adr-export
          # Check if git-adr is initialized and has ADRs
          if ./target/release/git-adr list --format json 2>/dev/null | grep -q '"id"'; then
            ./target/release/git-adr export --output adr-export --format markdown --index
            echo "ADRs exported successfully"
            ls -la adr-export/
          else
            echo "No ADRs found in git notes, creating placeholder"
            mkdir -p adr-export
            cat > adr-export/index.md << 'EOF'
          # Architecture Decision Records

          No ADRs have been created yet. Use `git adr new "Title"` to create your first ADR.
          EOF
          fi

      - name: Generate ADR viewer
        uses: zircote/adrscope@v0
        with:
          command: generate
          input-dir: adr-export
          output: adr-viewer.html
          theme: system
        continue-on-error: true

      - name: Create fallback ADR viewer
        if: failure() || !hashFiles('adr-viewer.html')
        run: |
          if [ ! -f "adr-viewer.html" ]; then
            cat > adr-viewer.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>git-adr - Architecture Decision Records</title>
            <meta charset="utf-8">
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; max-width: 800px; margin: 0 auto; padding: 2rem; }
              h1 { color: #333; }
              p { color: #666; }
              a { color: #0066cc; }
            </style>
          </head>
          <body>
            <h1>git-adr Architecture Decision Records</h1>
            <p>ADR viewer is being set up. Check back soon or visit the <a href="docs/">API documentation</a>.</p>
            <p>git-adr stores ADRs in git notes. Use <code>git adr list</code> to view decisions.</p>
          </body>
          </html>
          EOF
          fi

      - name: Determine version
        id: version
        env:
          EVENT_NAME: ${{ github.event_name }}
          RELEASE_TAG: ${{ github.event.release.tag_name }}
          INPUT_VERSION: ${{ inputs.version }}
        run: |
          if [ "$EVENT_NAME" == "release" ]; then
            echo "version=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          elif [ "$EVENT_NAME" == "workflow_dispatch" ]; then
            echo "version=$INPUT_VERSION" >> "$GITHUB_OUTPUT"
          else
            echo "version=latest" >> "$GITHUB_OUTPUT"
          fi

      - name: Validate documentation
        run: |
          # Validate docs path exists
          if [ ! -d "target/doc" ]; then
            echo "::error::Documentation path does not exist: target/doc"
            exit 1
          fi

          # Validate index.html exists
          if [ ! -f "target/doc/index.html" ]; then
            echo "::error::No index.html found in documentation path"
            exit 1
          fi

          echo "Documentation validation passed"

      - name: Package documentation
        id: package
        run: |
          ARTIFACT_DIR="/tmp/docs-deploy-git-adr"
          mkdir -p "$ARTIFACT_DIR"

          echo "Packaging documentation from target/doc"

          # Create zip archive
          cd target/doc
          zip -r "$ARTIFACT_DIR/docs.zip" . \
            -x "*.git*" \
            -x "*.env*" \
            -x "*.key" \
            -x "*.pem"

          # Copy ADR viewer if it exists
          if [ -f "$GITHUB_WORKSPACE/adr-viewer.html" ]; then
            cp "$GITHUB_WORKSPACE/adr-viewer.html" "$ARTIFACT_DIR/adrs.html"
            echo "Included ADR viewer"
            echo "include_adrs=true" >> "$GITHUB_OUTPUT"
          else
            echo "include_adrs=false" >> "$GITHUB_OUTPUT"
          fi

          # Log artifact info
          SIZE=$(du -h "$ARTIFACT_DIR/docs.zip" | cut -f1)
          echo "Artifact size: $SIZE"

          echo "## Documentation Deployment" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "| Input | Value |" >> "$GITHUB_STEP_SUMMARY"
          echo "|-------|-------|" >> "$GITHUB_STEP_SUMMARY"
          echo "| Project ID | \`git-adr\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Version | \`${{ steps.version.outputs.version }}\` |" >> "$GITHUB_STEP_SUMMARY"
          echo "| Artifact Size | $SIZE |" >> "$GITHUB_STEP_SUMMARY"

      - name: Upload artifact
        uses: actions/upload-artifact@v6
        with:
          name: docs-git-adr
          path: /tmp/docs-deploy-git-adr/
          retention-days: 1

      - name: Dispatch deployment
        env:
          DOCS_DEPLOY_TOKEN: ${{ secrets.DOCS_DEPLOY_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          INCLUDE_ADRS: ${{ steps.package.outputs.include_adrs }}
        run: |
          if [ -z "$DOCS_DEPLOY_TOKEN" ]; then
            echo "::error::DOCS_DEPLOY_TOKEN secret is required"
            echo "::error::Create a PAT with 'repo' scope and add it as a repository secret"
            exit 1
          fi

          # Build the payload
          PAYLOAD=$(cat << EOFPAYLOAD
          {
            "event_type": "deploy-docs",
            "client_payload": {
              "project_id": "git-adr",
              "version": "${VERSION}",
              "artifact_run_id": "${GITHUB_RUN_ID}",
              "include_adrs": ${INCLUDE_ADRS},
              "source_repo": "${GITHUB_REPOSITORY}",
              "source_sha": "${GITHUB_SHA}",
              "source_ref": "${GITHUB_REF}"
            }
          }
          EOFPAYLOAD
          )

          echo "Dispatching to: zircote/zircote.github.io"

          # Dispatch repository_dispatch event to target repo
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $DOCS_DEPLOY_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/zircote/zircote.github.io/dispatches" \
            -d "$PAYLOAD")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          if [ "$HTTP_CODE" != "204" ]; then
            echo "::error::Failed to dispatch deployment. HTTP $HTTP_CODE"
            echo "Response: $BODY"
            exit 1
          fi

          URL="https://www.zircote.com/projects/git-adr/docs/"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "### Deployment Dispatched" >> "$GITHUB_STEP_SUMMARY"
          echo "Documentation will be available at: $URL" >> "$GITHUB_STEP_SUMMARY"
          echo "" >> "$GITHUB_STEP_SUMMARY"
          echo "Monitor deployment: https://github.com/zircote/zircote.github.io/actions" >> "$GITHUB_STEP_SUMMARY"
